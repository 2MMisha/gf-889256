name: Update tournaments list
on:
  push:
    branches: [ main ]
    paths:
      - 'tournaments/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Generate folders list and index
        run: |
          # Создаем массив с названиями папок
          folders=()
          for d in tournaments/*/ ; do
            if [ -d "$d" ]; then
              folder=$(basename "$d")
              folders+=("$folder")
            fi
          done
          
          # Создаем folders.json (список папок)
          printf '%s\n' "${folders[@]}" | jq -R . | jq -s . > tournaments/folders.json
          
          # Создаем index.json (данные из info.json)
          echo "{" > tournaments/index.json
          first=true
          for folder in "${folders[@]}"; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> tournaments/index.json
            fi
            
            if [ -f "tournaments/$folder/info.json" ]; then
              echo -n "  \"$folder\": " >> tournaments/index.json
              cat "tournaments/$folder/info.json" >> tournaments/index.json
            else
              name=$(echo "$folder" | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
              echo -n "  \"$folder\": { \"name\": \"$name\", \"date\": \"TBA\", \"location\": \"TBA\" }" >> tournaments/index.json
            fi
          done
          echo "" >> tournaments/index.json
          echo "}" >> tournaments/index.json
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add tournaments/folders.json tournaments/index.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto-update tournaments data"
          git push
